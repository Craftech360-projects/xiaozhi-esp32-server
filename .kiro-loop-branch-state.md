# Loop Playback Branch - Current Working State Documentation

**Branch:** play-songs-in-loop-app  
**Backup Branch:** backup-loop-playback-20251030  
**Date:** October 30, 2025

## Overview

This document captures the current working state of the loop playback feature before merging into the dev branch.

## Working Features

### 1. Loop Playback from Mobile App ‚úÖ

- **Status:** WORKING
- **Description:** Users can enable loop mode in the mobile app content library and play music/stories continuously
- **Implementation:**
  - Mobile app sends `loop_enabled: true` parameter in MQTT messages
  - MQTT Gateway maintains loop state via `LoopStateManager`
  - LiveKit agent plays random content of the same type after each item completes

### 2. Volume Control from Mobile App ‚úÖ

- **Status:** WORKING (inherited from previous implementation)
- **Description:** Users can adjust device volume from mobile app
- **Implementation:**
  - Mobile app sends volume commands via MQTT
  - Commands forwarded to device via MCP protocol

### 3. Stop Loop Functionality ‚úÖ

- **Status:** WORKING
- **Description:** Users can stop loop playback from mobile app
- **Implementation:**
  - Mobile app sends stop command
  - MQTT Gateway clears loop state and forwards `stop_audio` to LiveKit agent
  - LiveKit agent stops playback and clears loop state

## Key Components

### MQTT Gateway (server/main/mqtt-gateway/app.js)

#### LoopStateManager Class (Lines 136-173)

```javascript
class LoopStateManager {
  constructor() {
    this.loopStates = new Map(); // macAddress -> { loopEnabled, contentType }
  }

  setLoopState(macAddress, loopEnabled, contentType) {
    // Stores loop state per device
    // Logs: "üîÅ [LOOP] Loop state enabled for {mac} - Type: {type}"
  }

  getLoopState(macAddress) {
    // Returns loop state or null
  }

  clearLoopState(macAddress) {
    // Removes loop state
    // Logs: "üîÅ [LOOP] Loop state cleared for {mac}"
  }

  isLoopEnabled(macAddress) {
    // Returns boolean
  }
}
```

#### handleMobileMusicRequest Method (Lines 1428-1508)

- Receives music/story play requests from mobile app
- Extracts `loop_enabled` parameter (defaults to false)
- Updates `loopStateManager` with loop state
- Forwards function call to LiveKit agent via data channel
- Supports both music and story content types
- Logs: "‚úÖ [MOBILE] Music request forwarded to LiveKit agent"

#### handleStopLoopRequest Method (Lines 1510-1548)

- Receives stop loop requests from mobile app
- Creates `stop_audio` function call message
- Forwards to LiveKit agent via data channel
- Logs: "‚úÖ [LOOP-STOP] Stop request forwarded to LiveKit agent"

### LiveKit Server (server/main/livekit-server/src/agent/main_agent.py)

#### play_music Function (Lines 258-363)

- **Parameters:**
  - `song_name: Optional[str]` - Specific song or None for random
  - `language: Optional[str]` - Language filter or None for any
  - `loop_enabled: bool = False` - Enable continuous playback
- **Behavior:**
  - Searches for specific song or gets random song
  - Stores loop state: `self.loop_enabled = True`, `self.loop_content_type = 'music'`
  - Registers completion callback: `on_completion_callback=self._continue_loop_playback`
  - Sends `music_playback_started` via data channel
  - Returns `[MUSIC_PLAYING - STAY_SILENT]` to suppress TTS response
- **Logs:** "üîÅ Loop mode enabled for music (will play ANY random songs)"

#### play_story Function (Lines 365-448)

- **Parameters:**
  - `story_name: Optional[str]` - Specific story or None for random
  - `category: Optional[str]` - Category filter or None for any
  - `loop_enabled: bool = False` - Enable continuous playback
- **Behavior:**
  - Searches for specific story or gets random story
  - Stores loop state: `self.loop_enabled = True`, `self.loop_content_type = 'story'`
  - Registers completion callback: `on_completion_callback=self._continue_loop_playback`
  - Returns `[STORY_PLAYING - STAY_SILENT]` to suppress TTS response
- **Logs:** "üîÅ Loop mode enabled for stories (will play ANY random stories)"

#### \_continue_loop_playback Method (Lines 553-600)

- **Purpose:** Automatically play next random content when current item completes
- **Behavior:**
  - Checks if `self.loop_enabled` is still true
  - Gets context from audio player
  - Calls `play_music()` or `play_story()` with:
    - `song_name=None` / `story_name=None` (random selection)
    - `language=None` / `category=None` (ANY content - no filter)
    - `loop_enabled=True` (continue looping)
  - Disables loop on error to prevent infinite error loop
- **Logs:** "üîÅ Continuing loop playback - Type: {type} (ANY random content)"

#### stop_audio Function

- Stops unified audio player
- Clears loop state: `self.loop_enabled = False`
- Prevents completion callback from triggering

## Data Flow

### Play Music/Story with Loop

```
Mobile App (loop_enabled=true)
  ‚Üì MQTT: mobile_music_request
MQTT Gateway (app.js)
  ‚îú‚îÄ loopStateManager.setLoopState(mac, true, 'music')
  ‚îî‚îÄ Forward function_call to LiveKit
      ‚Üì Data Channel
LiveKit Agent (main_agent.py)
  ‚îú‚îÄ play_music(loop_enabled=True)
  ‚îú‚îÄ self.loop_enabled = True
  ‚îî‚îÄ player.play_from_url(url, on_completion_callback=_continue_loop_playback)
      ‚Üì On Completion
  _continue_loop_playback()
  ‚îî‚îÄ play_music(song_name=None, language=None, loop_enabled=True)
      ‚Üì Repeat
```

### Stop Loop

```
Mobile App (stop button)
  ‚Üì MQTT: mobile_stop_loop
MQTT Gateway (app.js)
  ‚îú‚îÄ loopStateManager.clearLoopState(mac)
  ‚îî‚îÄ Forward stop_audio function_call
      ‚Üì Data Channel
LiveKit Agent (main_agent.py)
  ‚îú‚îÄ stop_audio()
  ‚îú‚îÄ self.loop_enabled = False
  ‚îî‚îÄ unified_audio_player.stop()
```

## Known Issues and Limitations

### 1. Loop State Persistence

- **Issue:** Loop state is stored in memory only
- **Impact:** Loop state is lost if MQTT Gateway restarts
- **Workaround:** Mobile app maintains loop preference and re-enables on reconnect

### 2. No Language/Category Filtering in Loop

- **Behavior:** Loop plays ANY random content of the same type (music/story)
- **Design Decision:** Intentional - provides variety in loop playback
- **Note:** Initial request can specify language/category, but subsequent loop items are random

### 3. Network Disconnection

- **Issue:** If device disconnects during loop playback, loop state may become stale
- **Mitigation:** Mobile app can re-send stop command or re-enable loop on reconnect

### 4. Multiple Devices

- **Status:** Loop state is per-device (by MAC address)
- **Behavior:** Each device can have independent loop state
- **Working:** Tested and confirmed working

## Testing Performed

### Manual Testing ‚úÖ

- [x] Enable loop mode in mobile app
- [x] Play music from content library
- [x] Verify music continues after first song completes
- [x] Verify random songs are played (not same song)
- [x] Disable loop mode
- [x] Verify playback stops after current song
- [x] Test stop button during loop playback
- [x] Test with stories (same behavior as music)
- [x] Test with multiple devices

### Integration Testing ‚úÖ

- [x] MQTT Gateway receives mobile_music_request correctly
- [x] LoopStateManager stores and retrieves state correctly
- [x] LiveKit agent receives function calls via data channel
- [x] Completion callback triggers next playback
- [x] Stop command clears loop state

## Mobile App Integration

### Content Library Screen

- **File:** `mobile_app/lib/screens/content/content_library_screen.dart`
- **Features:**
  - Loop toggle button (separate for music and stories)
  - Loop state persisted via `LoopModeService`
  - `loop_enabled` parameter sent in `sendMusicCommand()`
  - Stop button sends stop command

### Device Command Service

- **File:** `mobile_app/lib/services/device_command_service.dart`
- **Method:** `sendMusicCommand(macAddress, item, loopEnabled: bool)`
- **MQTT Topic:** `app/p2p/{macAddress}`
- **Message Format:**

```dart
{
  "type": "mobile_music_request",
  "song_name": item.title,
  "content_type": item.contentType, // 'music' or 'story'
  "language": item.language,
  "loop_enabled": loopEnabled
}
```

## Configuration

### No Environment Variables Required

- Loop feature works with existing configuration
- No new .env variables needed

### Dependencies

- Existing MQTT connection
- Existing LiveKit connection
- Existing music/story services (Qdrant)

## Performance Metrics

### Memory Usage

- LoopStateManager: < 1KB per device
- No memory leaks observed during extended loop playback

### CPU Usage

- Loop logic is event-driven (negligible CPU)
- Audio playback CPU usage unchanged

### Network Usage

- No additional MQTT messages during loop
- Audio streaming same as non-loop playback

## Merge Considerations

### Files Modified in Loop Branch

1. `server/main/mqtt-gateway/app.js`

   - Added LoopStateManager class
   - Added handleMobileMusicRequest method
   - Added handleStopLoopRequest method
   - Added MQTT message handlers for mobile requests

2. `server/main/livekit-server/src/agent/main_agent.py`

   - Added `loop_enabled` parameter to play_music
   - Added `loop_enabled` parameter to play_story
   - Added `_continue_loop_playback` method
   - Added loop state tracking (self.loop_enabled, self.loop_content_type)

3. `server/main/livekit-server/src/services/unified_audio_player.py`
   - Added `on_completion_callback` parameter to play_from_url
   - Added callback invocation on playback completion

### Conflicts Expected with Dev Branch

- `app.js`: Dev has audio-worker.js integration
- `main.py`: Dev has template system and Google search
- `main_agent.py`: May have function signature changes

### Merge Strategy

- Keep loop logic from this branch
- Integrate audio-worker.js from dev
- Preserve working function signatures
- Test thoroughly after merge

## Success Criteria for Merge

- [ ] Loop playback still works from mobile app
- [ ] Audio worker optimization is active
- [ ] Volume control still works
- [ ] Stop functionality still works
- [ ] No regressions in existing features
- [ ] All integration tests pass

---

**Documentation Complete**  
This state document will be used as reference during the merge process.
