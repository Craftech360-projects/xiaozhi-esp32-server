# Railway Cloud MySQL Setup Guide

## 1. Create Railway Account & Project

### Step 1: Sign Up / Login
1. Go to [Railway.app](https://railway.app)
2. Sign up with GitHub (recommended) or email
3. Verify your account

### Step 2: Create New Project
1. Click **"New Project"** on dashboard
2. Select **"Empty Project"** (we'll add MySQL manually)
3. Give your project a name: `xiaozhi-ai-toy`

## 2. Add MySQL Database

### Option A: Via Dashboard (Easiest)
1. In your project, click **"+ New"**
2. Select **"Database"** 
3. Choose **"MySQL"**
4. Railway will automatically provision a MySQL 8.0 instance

### Option B: Via CLI
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link to your project
railway link

# Add MySQL
railway add mysql
```

## 3. Get Database Credentials

### From Dashboard:
1. Click on your MySQL service
2. Go to **"Variables"** tab
3. You'll see these environment variables:

```bash
MYSQLHOST=<something>.railway.app
MYSQLPORT=<port>
MYSQLDATABASE=railway
MYSQLUSER=root
MYSQLPASSWORD=<auto-generated-password>
MYSQL_PUBLIC_URL=mysql://root:password@host:port/railway
MYSQL_PRIVATE_URL=mysql://root:password@host:port/railway
```

### Copy Connection Details:
Create a `.env.railway` file:
```bash
# Railway MySQL Connection
RAILWAY_MYSQL_HOST=viaduct.proxy.rlwy.net
RAILWAY_MYSQL_PORT=47806
RAILWAY_MYSQL_DATABASE=railway
RAILWAY_MYSQL_USER=root
RAILWAY_MYSQL_PASSWORD=your-generated-password

# Full connection URLs
RAILWAY_MYSQL_PUBLIC_URL=mysql://root:password@viaduct.proxy.rlwy.net:47806/railway
RAILWAY_MYSQL_PRIVATE_URL=mysql://root:password@mysql.railway.internal:3306/railway
```

## 4. Configure Application Connection

### Update application.yml:
```yaml
spring:
  profiles:
    active: railway  # or production
    
---
# Railway/Production Profile
spring:
  config:
    activate:
      on-profile: railway
      
  datasource:
    # Use environment variables for security
    url: jdbc:mysql://${RAILWAY_MYSQL_HOST}:${RAILWAY_MYSQL_PORT}/${RAILWAY_MYSQL_DATABASE}?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC&useSSL=true&allowPublicKeyRetrieval=true
    username: ${RAILWAY_MYSQL_USER}
    password: ${RAILWAY_MYSQL_PASSWORD}
    
    # Alternative: Direct URL (less secure, only for testing)
    # url: jdbc:mysql://viaduct.proxy.rlwy.net:47806/railway?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC&useSSL=true
    
    druid:
      driver-class-name: com.mysql.cj.jdbc.Driver
      initial-size: 5
      max-active: 20
      min-idle: 5
      max-wait: 60000
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false
      
      # Railway-specific optimizations
      keep-alive: true
      keep-alive-between-time-millis: 30000
      connection-properties: useSSL=true;requireSSL=false;allowPublicKeyRetrieval=true
```

### For Python xiaozhi-server:
```python
# config.yaml
database:
  host: ${RAILWAY_MYSQL_HOST}
  port: ${RAILWAY_MYSQL_PORT}
  database: ${RAILWAY_MYSQL_DATABASE}
  user: ${RAILWAY_MYSQL_USER}
  password: ${RAILWAY_MYSQL_PASSWORD}
  
# Or direct in code
import os
import mysql.connector

config = {
    'host': os.getenv('RAILWAY_MYSQL_HOST', 'viaduct.proxy.rlwy.net'),
    'port': os.getenv('RAILWAY_MYSQL_PORT', '47806'),
    'database': os.getenv('RAILWAY_MYSQL_DATABASE', 'railway'),
    'user': os.getenv('RAILWAY_MYSQL_USER', 'root'),
    'password': os.getenv('RAILWAY_MYSQL_PASSWORD'),
    'use_unicode': True,
    'charset': 'utf8mb4',
    'autocommit': True,
    'pool_name': 'xiaozhi_pool',
    'pool_size': 5
}

connection = mysql.connector.connect(**config)
```

## 5. Connect with DBeaver

### DBeaver Connection Settings:
1. **Main Tab:**
   - Server Host: `viaduct.proxy.rlwy.net` (your actual host)
   - Port: `47806` (your actual port)
   - Database: `railway`
   - Username: `root`
   - Password: (your generated password)

2. **SSL Tab:**
   - Use SSL: ✅ Check
   - SSL Mode: PREFERRED
   - Allow public key retrieval: ✅ Check

3. **Driver Properties:**
   - useSSL: true
   - allowPublicKeyRetrieval: true
   - useUnicode: true
   - characterEncoding: UTF-8
   - serverTimezone: UTC

4. Test Connection → Should show "Connected"

## 6. Initialize Database Schema

### Option 1: Via DBeaver
1. Connect to Railway MySQL
2. Open SQL Editor
3. Copy and paste the initialization script:

```sql
-- ================================================
-- Xiaozhi AI Toy Database Schema for Railway
-- ================================================

-- Ensure UTF8MB4 support
ALTER DATABASE railway CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- System Users (Parents)
CREATE TABLE IF NOT EXISTS sys_user (
  id BIGINT NOT NULL AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL,
  password VARCHAR(100),
  email VARCHAR(100),
  phone VARCHAR(20),
  super_admin TINYINT UNSIGNED DEFAULT 0,
  status TINYINT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_username (username),
  UNIQUE KEY uk_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Authentication Tokens
CREATE TABLE IF NOT EXISTS sys_user_token (
  id BIGINT NOT NULL AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  token VARCHAR(100) NOT NULL,
  expire_date DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_id (user_id),
  UNIQUE KEY uk_token (token),
  FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Devices
CREATE TABLE IF NOT EXISTS ai_device (
  id VARCHAR(32) NOT NULL,
  mac_address VARCHAR(50) NOT NULL,
  device_name VARCHAR(100),
  firmware_version VARCHAR(20),
  last_connected_at DATETIME,
  is_online BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_mac (mac_address),
  INDEX idx_online (is_online)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Child Profiles
CREATE TABLE IF NOT EXISTS child_profile (
  id VARCHAR(32) NOT NULL,
  parent_user_id BIGINT NOT NULL,
  child_name VARCHAR(100) NOT NULL,
  age INT,
  gender VARCHAR(10),
  device_id VARCHAR(32),
  avatar_url VARCHAR(255),
  preferences JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  FOREIGN KEY (parent_user_id) REFERENCES sys_user(id),
  FOREIGN KEY (device_id) REFERENCES ai_device(id),
  INDEX idx_parent (parent_user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Chat Sessions
CREATE TABLE IF NOT EXISTS chat_sessions (
  id VARCHAR(32) NOT NULL,
  child_profile_id VARCHAR(32) NOT NULL,
  device_id VARCHAR(32),
  session_start DATETIME NOT NULL,
  session_end DATETIME,
  duration_seconds INT,
  interaction_count INT DEFAULT 0,
  PRIMARY KEY (id),
  FOREIGN KEY (child_profile_id) REFERENCES child_profile(id),
  INDEX idx_child_date (child_profile_id, session_start)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Chat Messages
CREATE TABLE IF NOT EXISTS chat_messages (
  id BIGINT NOT NULL AUTO_INCREMENT,
  session_id VARCHAR(32) NOT NULL,
  role ENUM('user', 'assistant', 'system') NOT NULL,
  content TEXT NOT NULL,
  audio_url VARCHAR(255),
  timestamp DATETIME(3) DEFAULT CURRENT_TIMESTAMP(3),
  PRIMARY KEY (id),
  FOREIGN KEY (session_id) REFERENCES chat_sessions(id),
  INDEX idx_session_time (session_id, timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Daily Analytics
CREATE TABLE IF NOT EXISTS daily_analytics (
  id BIGINT NOT NULL AUTO_INCREMENT,
  child_profile_id VARCHAR(32) NOT NULL,
  analytics_date DATE NOT NULL,
  total_sessions INT DEFAULT 0,
  total_minutes INT DEFAULT 0,
  total_interactions INT DEFAULT 0,
  topics_discussed JSON,
  sentiment_summary JSON,
  learning_metrics JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_child_date (child_profile_id, analytics_date),
  FOREIGN KEY (child_profile_id) REFERENCES child_profile(id),
  INDEX idx_child_date_desc (child_profile_id, analytics_date DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Insert test data
INSERT INTO sys_user (username, password, email) 
VALUES ('admin', '$2a$10$EblZqNptyYvcLm/VwDCVAuBjzZOI7khzdyGPBr08PpIi0na624b8.', 'admin@xiaozhi.ai');
```

### Option 2: Via Command Line
```bash
# Install mysql client if needed
brew install mysql-client

# Connect to Railway MySQL
mysql -h viaduct.proxy.rlwy.net -P 47806 -u root -p railway

# Then paste the SQL commands
```

### Option 3: Via Application Code
```javascript
// Node.js migration script
const mysql = require('mysql2/promise');
const fs = require('fs');

async function initDatabase() {
    const connection = await mysql.createConnection({
        host: process.env.RAILWAY_MYSQL_HOST,
        port: process.env.RAILWAY_MYSQL_PORT,
        user: process.env.RAILWAY_MYSQL_USER,
        password: process.env.RAILWAY_MYSQL_PASSWORD,
        database: process.env.RAILWAY_MYSQL_DATABASE,
        multipleStatements: true
    });
    
    const schema = fs.readFileSync('init.sql', 'utf8');
    await connection.query(schema);
    console.log('Database initialized successfully');
    
    await connection.end();
}

initDatabase().catch(console.error);
```

## 7. Test Connection

### Quick Test Script (Node.js):
```javascript
// test-railway-connection.js
const mysql = require('mysql2/promise');
require('dotenv').config({ path: '.env.railway' });

async function testConnection() {
    try {
        const connection = await mysql.createConnection({
            host: process.env.RAILWAY_MYSQL_HOST,
            port: process.env.RAILWAY_MYSQL_PORT,
            user: process.env.RAILWAY_MYSQL_USER,
            password: process.env.RAILWAY_MYSQL_PASSWORD,
            database: process.env.RAILWAY_MYSQL_DATABASE
        });
        
        console.log('✅ Connected to Railway MySQL');
        
        // Test query
        const [rows] = await connection.execute('SELECT VERSION() as version');
        console.log('MySQL Version:', rows[0].version);
        
        // Show tables
        const [tables] = await connection.execute('SHOW TABLES');
        console.log('Tables:', tables.map(t => Object.values(t)[0]));
        
        // Test data insertion
        const [result] = await connection.execute(
            'INSERT INTO sys_user (username, email) VALUES (?, ?)',
            ['test_parent', 'test@example.com']
        );
        console.log('Test insert successful, ID:', result.insertId);
        
        await connection.end();
        console.log('✅ All tests passed!');
        
    } catch (error) {
        console.error('❌ Connection failed:', error.message);
    }
}

testConnection();
```

Run test:
```bash
npm install mysql2 dotenv
node test-railway-connection.js
```

### Python Test:
```python
# test_railway_connection.py
import os
import mysql.connector
from dotenv import load_dotenv

load_dotenv('.env.railway')

def test_connection():
    try:
        conn = mysql.connector.connect(
            host=os.getenv('RAILWAY_MYSQL_HOST'),
            port=os.getenv('RAILWAY_MYSQL_PORT'),
            database=os.getenv('RAILWAY_MYSQL_DATABASE'),
            user=os.getenv('RAILWAY_MYSQL_USER'),
            password=os.getenv('RAILWAY_MYSQL_PASSWORD')
        )
        
        print("✅ Connected to Railway MySQL")
        
        cursor = conn.cursor()
        cursor.execute("SELECT VERSION()")
        version = cursor.fetchone()
        print(f"MySQL Version: {version[0]}")
        
        cursor.execute("SHOW TABLES")
        tables = cursor.fetchall()
        print(f"Tables: {[table[0] for table in tables]}")
        
        cursor.close()
        conn.close()
        print("✅ All tests passed!")
        
    except mysql.connector.Error as err:
        print(f"❌ Connection failed: {err}")

if __name__ == "__main__":
    test_connection()
```

## 8. Railway-Specific Optimizations

### Connection Pooling:
```yaml
# Optimal settings for Railway
spring:
  datasource:
    druid:
      initial-size: 3        # Lower for Railway
      max-active: 10         # Railway has connection limits
      min-idle: 2
      max-wait: 30000
      # Important for Railway's proxy
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: true   # Enable for Railway
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
```

### Handle Connection Drops:
```python
# Python with retry logic
import time
from mysql.connector import pooling

config = {
    'host': os.getenv('RAILWAY_MYSQL_HOST'),
    'port': os.getenv('RAILWAY_MYSQL_PORT'),
    'database': os.getenv('RAILWAY_MYSQL_DATABASE'),
    'user': os.getenv('RAILWAY_MYSQL_USER'),
    'password': os.getenv('RAILWAY_MYSQL_PASSWORD'),
    'pool_name': 'railway_pool',
    'pool_size': 5,
    'pool_reset_session': True,
    'autocommit': True
}

pool = pooling.MySQLConnectionPool(**config)

def execute_with_retry(query, params=None, max_retries=3):
    for attempt in range(max_retries):
        try:
            conn = pool.get_connection()
            cursor = conn.cursor()
            cursor.execute(query, params)
            result = cursor.fetchall()
            cursor.close()
            conn.close()
            return result
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            time.sleep(2 ** attempt)  # Exponential backoff
```

## 9. Monitor Database Usage

### Railway Dashboard:
1. Go to your MySQL service in Railway
2. Click on **"Metrics"** tab
3. Monitor:
   - Memory usage (limit: 512MB on free tier)
   - CPU usage
   - Network I/O
   - Disk usage (limit: 1GB on free tier)

### Database Size Query:
```sql
-- Check database size
SELECT 
    table_schema AS 'Database',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size_MB'
FROM information_schema.tables
WHERE table_schema = 'railway'
GROUP BY table_schema;

-- Check individual table sizes
SELECT 
    table_name AS 'Table',
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size_MB',
    table_rows AS 'Rows'
FROM information_schema.tables
WHERE table_schema = 'railway'
ORDER BY (data_length + index_length) DESC;
```

## 10. Backup Strategy

### Manual Backup:
```bash
# Export from Railway
mysqldump -h viaduct.proxy.rlwy.net -P 47806 -u root -p railway > backup_$(date +%Y%m%d).sql

# Compress
gzip backup_$(date +%Y%m%d).sql
```

### Automated Backup (GitHub Actions):
```yaml
# .github/workflows/backup.yml
name: Database Backup

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Backup Railway MySQL
        env:
          MYSQL_HOST: ${{ secrets.RAILWAY_MYSQL_HOST }}
          MYSQL_PORT: ${{ secrets.RAILWAY_MYSQL_PORT }}
          MYSQL_USER: ${{ secrets.RAILWAY_MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.RAILWAY_MYSQL_PASSWORD }}
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client
          
          DATE=$(date +%Y%m%d_%H%M%S)
          mysqldump -h $MYSQL_HOST -P $MYSQL_PORT -u $MYSQL_USER -p$MYSQL_PASSWORD railway > backup_$DATE.sql
          gzip backup_$DATE.sql
          
      - name: Upload to S3/Google Cloud
        # Add your cloud storage upload step
```

## 11. Railway CLI Commands

### Useful Commands:
```bash
# Install CLI
npm install -g @railway/cli

# Login
railway login

# Link project
railway link

# View logs
railway logs

# Open dashboard
railway open

# Show environment variables
railway variables

# Connect to database
railway connect mysql

# Run commands in Railway environment
railway run npm start

# Deploy
railway up
```

## 12. Cost Management

### Railway Pricing (as of 2025):
- **Free Tier**: 
  - $5 credit/month
  - 512MB RAM
  - 1GB storage
  - Shared CPU

- **Hobby Plan** ($5/month):
  - 8GB RAM
  - 100GB storage
  - More CPU

- **Pro Plan** ($20/month):
  - Unlimited resources
  - Multiple environments
  - Team collaboration

### Optimize Costs:
1. **Clean old data regularly**:
```sql
-- Delete old chat messages (keep 90 days)
DELETE FROM chat_messages 
WHERE timestamp < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- Archive analytics older than 1 year
CREATE TABLE daily_analytics_archive LIKE daily_analytics;
INSERT INTO daily_analytics_archive 
SELECT * FROM daily_analytics 
WHERE analytics_date < DATE_SUB(NOW(), INTERVAL 1 YEAR);
DELETE FROM daily_analytics 
WHERE analytics_date < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

2. **Use connection pooling** to minimize connections
3. **Cache frequently accessed data** in Redis
4. **Optimize queries** with proper indexes

## 13. Troubleshooting

### Common Issues:

#### SSL/TLS Error:
```yaml
# Add to connection string
?useSSL=true&requireSSL=false&allowPublicKeyRetrieval=true&verifyServerCertificate=false
```

#### Connection Timeout:
```python
# Increase timeout
config = {
    'connect_timeout': 30,
    'connection_timeout': 30,
    'autocommit': True,
    'use_pure': True  # Use pure Python implementation
}
```

#### "Too Many Connections":
- Reduce pool size
- Check for connection leaks
- Use Railway's private networking if available

#### Slow Queries:
```sql
-- Enable slow query monitoring
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- Check running queries
SHOW PROCESSLIST;

-- Kill slow query
KILL QUERY <process_id>;
```

## Next Steps

1. ✅ Create Railway account and project
2. ✅ Add MySQL database
3. ✅ Copy connection credentials to `.env.railway`
4. ✅ Connect with DBeaver
5. ✅ Run initialization script
6. ✅ Test connection with provided scripts
7. 🚀 Start developing!

## Support Resources

- [Railway Documentation](https://docs.railway.app)
- [Railway Discord](https://discord.gg/railway)
- [Railway Status](https://status.railway.app)
- [MySQL on Railway Guide](https://docs.railway.app/databases/mysql)

Remember to:
- Never commit credentials to Git
- Use environment variables in production
- Set up regular backups
- Monitor usage to stay within limits
- Enable 2FA on your Railway account