version: 2.1

# ==========================================
# üîÄ DYNAMIC PIPELINE ROUTER
# ==========================================
# This config determines which pipeline to run based on the branch
# - dev/circleci-validation branches ‚Üí dev-config.yml
# - main branch ‚Üí prod-config.yml
# ==========================================

# CRITICAL: Mark this as a setup workflow
setup: true

# Setup workflows require the continuation orb
orbs:
  continuation: circleci/continuation@1.0.0

# =========================
# Jobs
# =========================
jobs:
  # Determine which configuration to use based on branch
  setup:
    executor: continuation/default
    steps:
      - checkout
      - run:
          name: Determine Pipeline Configuration
          command: |
            # Get current branch
            BRANCH="${CIRCLE_BRANCH}"
            echo "Current branch: ${BRANCH}"

            # Determine which config to use and copy to generated_config.yml
            # TEMPORARY: Using prod-config for dev/circleci-validation for testing
            # TODO: Switch to main branch only after validation is complete
            if [[ "${BRANCH}" == "main" || "${BRANCH}" == "dev" || "${BRANCH}" == "circleci-validation" ]]; then
              echo "üöÄ Using PRODUCTION pipeline configuration"
              cp .circleci/prod-config.yml .circleci/generated_config.yml
            else
              echo "‚ö†Ô∏è  Branch '${BRANCH}' not configured for CI/CD"
              echo "Only main, dev, and circleci-validation branches trigger pipelines"
              exit 0
            fi

            # Verify config file was created
            if [ ! -f ".circleci/generated_config.yml" ]; then
              echo "‚ùå ERROR: Failed to generate config"
              exit 1
            fi

            echo "‚úÖ Configuration ready"

      - continuation/continue:
          configuration_path: .circleci/generated_config.yml

# =========================
# Workflows
# =========================
workflows:
  # Setup workflow runs first to determine which pipeline to execute
  setup-workflow:
    jobs:
      - setup:
          filters:
            branches:
              only:
                - main
                - dev
                - circleci-validation
