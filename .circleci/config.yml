version: 2.1

# ==========================================
# üîÑ DYNAMIC PIPELINE SELECTOR
# ==========================================
# This config determines which pipeline(s) to run based on the branch
# ALL BRANCHES: Testing pipeline always runs
# DEV BRANCH: Both testing and production pipelines run
# ==========================================

setup: true

orbs:
  continuation: circleci/continuation@0.3.1

jobs:
  setup_pipelines:
    executor: continuation/default
    steps:
      - checkout
      - run:
          name: "üîÑ Determine Pipeline Configuration"
          command: |
            echo "=================================================="
            echo "üîÑ XIAOZHI DYNAMIC PIPELINE SELECTOR"
            echo "=================================================="
            echo "üìä BRANCH ANALYSIS:"
            echo "  ‚Ä¢ Current Branch: $CIRCLE_BRANCH"
            echo "  ‚Ä¢ Commit: $CIRCLE_SHA1"
            echo "  ‚Ä¢ Build Number: $CIRCLE_BUILD_NUM"
            echo ""

            if [ "$CIRCLE_BRANCH" = "dev" ]; then
              echo "üéØ DEV BRANCH DETECTED:"
              echo "  ‚úÖ Testing Pipeline (Quality + Security + Performance)"
              echo "  ‚úÖ Production Pipeline (Build + Deploy to Azure)"
              echo ""
              echo "üìã CONFIGURATION: Combined pipelines for dev branch"
              echo ".circleci/combined-pipelines.yml" > /tmp/config_path
            else
              echo "üéØ FEATURE/OTHER BRANCH DETECTED:"
              echo "  ‚úÖ Testing Pipeline (Quality + Security + Performance)"
              echo "  ‚è≠Ô∏è  Production Pipeline (Skipped - not dev branch)"
              echo ""
              echo "üìã CONFIGURATION: Testing pipeline for all branches"
              echo ".circleci/testing-config.yml" > /tmp/config_path
            fi

            echo "=================================================="
            CONFIG_PATH=$(cat /tmp/config_path)
            echo "üöÄ Selected Configuration: $CONFIG_PATH"

            if [ ! -f "$CONFIG_PATH" ]; then
              echo "‚ùå ERROR: Configuration file $CONFIG_PATH not found"
              echo "Available files:"
              ls -la .circleci/
              exit 1
            fi

            echo "‚úÖ Configuration validated"
            echo "=================================================="
      - continuation/continue:
          configuration_path: "$(cat /tmp/config_path)"

workflows:
  setup:
    jobs:
      - setup_pipelines