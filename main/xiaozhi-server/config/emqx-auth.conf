# EMQX HTTP Authentication Configuration
# Save this as emqx.conf in your EMQX config directory
# Or add these settings to your existing emqx.conf file

# HTTP Authentication Configuration
authentication = [
  {
    # Authentication mechanism
    mechanism = password_based
    
    # Backend type - HTTP for external authentication
    backend = http
    
    # HTTP method for authentication requests
    method = post
    
    # Your xiaozhi-server HTTP authentication endpoint
    # Replace 192.168.1.111:8003 with your actual server IP and HTTP port
    url = "http://192.168.1.111:8003/mqtt/auth"
    
    # Request headers
    headers {
      "Content-Type" = "application/json"
      "User-Agent" = "EMQX-HTTP-Auth"
    }
    
    # Request body template - EMQX will substitute these variables
    body {
      client_id = "${clientid}"
      username = "${username}" 
      password = "${password}"
      # Optional: Include client IP and other info
      client_ip = "${peerhost}"
      protocol = "${proto_name}"
    }
    
    # Connection pool settings for better performance
    connect_timeout = 5s
    request_timeout = 10s
    pool_size = 8
    
    # SSL/TLS settings (if your xiaozhi-server uses HTTPS)
    # ssl {
    #   enable = false
    #   verify = verify_peer
    # }
    
    # Authentication success criteria
    # HTTP 200 = success, HTTP 401/403 = failure, others = ignore
    enable = true
  }
]

# Optional: Authorization configuration (if you want to control topic access)
authorization {
  # No authorization rules - allow all authenticated clients full access
  # You can add rules here later if needed
  sources = []
}

# Optional: MQTT settings
mqtt {
  # Maximum client ID length (your format: GID_test@@@mac_address@@@uuid)
  max_clientid_len = 200
  
  # Keep alive settings
  max_keepalive = 65535
  keepalive_multiplier = 1.25
  
  # Session settings
  max_inflight = 32
  retry_interval = 20s
  max_awaiting_rel = 100
}

# Logging configuration for debugging authentication
log {
  console {
    enable = true
    level = info
    # Set to debug for detailed authentication logs
    # level = debug
  }
  
  file {
    enable = true
    level = info
    file = "/var/log/emqx/emqx.log"
    # Set to debug for detailed authentication logs
    # level = debug
  }
}