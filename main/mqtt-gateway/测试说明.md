# MQTT Gateway Forwarding Function Test Guide

This document explains how to test whether the MQTT gateway forwarding function is configured successfully.

## Quick Test

### 1. Basic Connection Test

Run the quick test script:

```bash
node quick-test.js
```

This script will:
- ‚úÖ Check the configuration file
- ‚úÖ Test MQTT server connection (port 1883)
- ‚úÖ Test WebSocket backend service connection
- ‚úÖ Display test results and suggestions

### 2. Full Function Test

Run the full test script:

```bash
node test-mqtt.js
```

This script will:
- üîó Connect to the MQTT server
- üîê Authenticate using the configured MAC address
- üìù Subscribe to the reply topic
- üì§ Send a hello message to test WebSocket forwarding
- üì• Wait for and display server response
- üß™ Send other test messages

## Manual Test Steps

### 1. Start the MQTT Gateway

```bash
node app.js
```

You should see output similar to:
```
MQTT server started on port 1883
UDP server started on port 1883
Connections: 0, Active: 0
```

### 2. Check the Configuration File

Make sure `config/mqtt.json` is configured correctly:

```json
{
   "production": {
      "chat_servers": [
         "ws://192.168.68.66:8000/xiaozhi/v1/"
      ]
   },
   "development": {
      "chat_servers": ["ws://192.168.68.66:8000/xiaozhi/v1/"],
      "mac_addresss": ["d8:43:ae:3e:4b:5a"]
   },
   "debug": false
}
```

### 3. Test Using MQTT Client Tools

#### Using mosquitto client:

**Connection Test:**
```bash
mosquitto_pub -h localhost -p 1883 -t "test/topic" -m "hello"
```

**Subscription Test:**
```bash
mosquitto_sub -h localhost -p 1883 -t "devices/p2p/d8_43_ae_3e_4b_5a"
```

#### Using MQTT.fx or other GUI tools:

1. **Connection Settings:**
   - Server: localhost
   - Port: 1883
   - Client ID: `GID_test@@@d8_43_ae_3e_4b_5a`
   - Username: test_user
   - Password: test_password

2. **Publish Test Message:**
   - Topic: `test/topic`
   - Message:
   ```json
   {
      "type": "hello",
      "version": 3,
      "transport": "mqtt",
      "audio_params": {
         "sample_rate": 16000,
         "channels": 1,
         "format": "opus"
      },
      "features": ["tts", "asr"]
   }
   ```

3. **Subscribe to Reply Topic:**
   - Topic: `devices/p2p/d8_43_ae_3e_4b_5a`

## Test Result Criteria

### ‚úÖ Success Indicators

1. **MQTT Connection Successful:**
   ```
   ‚úì Successfully connected to MQTT server localhost:1883
   ‚úì MQTT connection successful
   ```

2. **WebSocket Forwarding Successful:**
   ```
   ‚úì WebSocket server connected successfully
   ‚úì Received PUBLISH message
   ```

3. **Server Logs Normal:**
   ```
   Client connected: { clientId: 'GID_test@@@d8_43_ae_3e_4b_5a', ... }
   Received publish message: { topic: 'test/topic', payload: '...', qos: 0 }
   ```

### ‚ùå Common Issues

1. **MQTT Server Connection Failed:**
   ```
   ‚úó Connection error: connect ECONNREFUSED 127.0.0.1:1883
   ```
   **Solution:** Make sure to run `node app.js` to start the MQTT gateway

2. **WebSocket Connection Failed:**
   ```
   ‚úó WebSocket server connection failed: connect ECONNREFUSED
   ```
   **Solution:** Check if the WebSocket backend service is running and the network is reachable

3. **Authentication Failed:**
   ```
   Invalid clientId: xxx
   ```
   **Solution:** Check if the client ID format is `GID_test@@@mac_address`

4. **MAC Address Mismatch:**
   ```
   No chat server found for xx:xx:xx:xx:xx:xx
   ```
   **Solution:** Make sure the MAC address is in the `mac_addresss` list in the configuration file

## Debugging Tips

### 1. Enable Debug Mode

Modify `config/mqtt.json`:
```json
{
   "debug": true
}
```

Or set environment variable:
```bash
DEBUG=mqtt-server node app.js
```

### 2. View Detailed Logs

Debug mode will show detailed connection and message handling info:
```
mqtt-server client connected: { clientId: '...', username: '...', ... }
mqtt-server received publish message: { topic: '...', payload: '...', qos: 0 }
mqtt-server sent message to devices/p2p/...: {...}
```

### 3. Network Connectivity Test

**Test WebSocket server:**
```bash
curl -I http://192.168.68.66:8000/xiaozhi/v1/
```

**Test MQTT port:**
```bash
telnet localhost 1883
```

## Performance Testing

### Concurrent Connection Test

You can modify the test script to create multiple concurrent connections:

```javascript
// Create multiple test clients
const clients = [];
for (let i = 0; i < 10; i++) {
   const client = new MQTTTestClient();
   clients.push(client);
   // Connect and test...
}
```

### Message Throughput Test

Send a large number of messages to test forwarding performance:

```javascript
// Send 100 messages
for (let i = 0; i < 100; i++) {
   client.publish('test/topic', `Test message ${i}`);
}
```

## Troubleshooting Checklist

- [ ] Is the MQTT gateway service running (`node app.js`)?
- [ ] Is port 1883 occupied?
- [ ] Is the configuration file format correct?
- [ ] Is the WebSocket backend service running?
- [ ] Is the network connection normal?
- [ ] Is the MAC address in the configured whitelist?
- [ ] Is the client ID format correct?
- [ ] Is the firewall blocking the connection?

## Summary

With the above test methods, you can comprehensively verify whether the MQTT gateway forwarding function is configured successfully. It is recommended to run the quick test first, and if there are issues, proceed with detailed manual testing and debugging.