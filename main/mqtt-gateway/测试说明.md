# MQTT网关转发功能测试指南

本文档说明如何测试MQTT网关的转发功能是否配置成功。

## 快速测试

### 1. 基础连接测试

运行快速测试脚本：

```bash
node quick-test.js
```

这个脚本会：
- ✅ 检查配置文件
- ✅ 测试MQTT服务器连接（端口1883）
- ✅ 测试WebSocket后端服务连接
- ✅ 显示测试结果和建议

### 2. 完整功能测试

运行完整测试脚本：

```bash
node test-mqtt.js
```

这个脚本会：
- 🔗 连接到MQTT服务器
- 🔐 使用配置的MAC地址进行认证
- 📝 订阅回复主题
- 📤 发送hello消息测试WebSocket转发
- 📥 等待并显示服务器响应
- 🧪 发送其他测试消息

## 手动测试步骤

### 1. 启动MQTT网关

```bash
node app.js
```

应该看到类似输出：
```
MQTT 服务器启动在端口 1883
UDP 服务器启动在端口 1883
连接数: 0, 活跃数: 0
```

### 2. 检查配置文件

确认 `config/mqtt.json` 配置正确：

```json
{
    "production": {
        "chat_servers": [
            "ws://192.168.68.66:8000/xiaozhi/v1/"
        ]
    },
    "development": {
        "chat_servers": ["ws://192.168.68.66:8000/xiaozhi/v1/"],
        "mac_addresss": ["d8:43:ae:3e:4b:5a"]
    },
    "debug": false
}
```

### 3. 使用MQTT客户端工具测试

#### 使用mosquitto客户端：

**连接测试：**
```bash
mosquitto_pub -h localhost -p 1883 -t "test/topic" -m "hello"
```

**订阅测试：**
```bash
mosquitto_sub -h localhost -p 1883 -t "devices/p2p/d8_43_ae_3e_4b_5a"
```

#### 使用MQTT.fx或其他GUI工具：

1. **连接设置：**
   - 服务器：localhost
   - 端口：1883
   - 客户端ID：`GID_test@@@d8_43_ae_3e_4b_5a`
   - 用户名：test_user
   - 密码：test_password

2. **发布测试消息：**
   - 主题：`test/topic`
   - 消息：
   ```json
   {
       "type": "hello",
       "version": 3,
       "transport": "mqtt",
       "audio_params": {
           "sample_rate": 16000,
           "channels": 1,
           "format": "opus"
       },
       "features": ["tts", "asr"]
   }
   ```

3. **订阅回复主题：**
   - 主题：`devices/p2p/d8_43_ae_3e_4b_5a`

## 测试结果判断

### ✅ 成功指标

1. **MQTT连接成功：**
   ```
   ✓ 成功连接到MQTT服务器 localhost:1883
   ✓ MQTT连接成功
   ```

2. **WebSocket转发成功：**
   ```
   ✓ WebSocket服务器连接成功
   ✓ 收到PUBLISH消息
   ```

3. **服务器日志正常：**
   ```
   客户端连接: { clientId: 'GID_test@@@d8_43_ae_3e_4b_5a', ... }
   收到发布消息: { topic: 'test/topic', payload: '...', qos: 0 }
   ```

### ❌ 常见问题

1. **MQTT服务器连接失败：**
   ```
   ✗ 连接错误: connect ECONNREFUSED 127.0.0.1:1883
   ```
   **解决方案：** 确保运行 `node app.js` 启动MQTT网关

2. **WebSocket连接失败：**
   ```
   ✗ WebSocket服务器连接失败: connect ECONNREFUSED
   ```
   **解决方案：** 检查WebSocket后端服务是否运行，网络是否可达

3. **认证失败：**
   ```
   无效的 clientId: xxx
   ```
   **解决方案：** 检查客户端ID格式是否为 `GID_test@@@mac_address`

4. **MAC地址不匹配：**
   ```
   未找到 xx:xx:xx:xx:xx:xx 的聊天服务器
   ```
   **解决方案：** 确认MAC地址在配置文件的 `mac_addresss` 列表中

## 调试技巧

### 1. 开启调试模式

修改 `config/mqtt.json`：
```json
{
    "debug": true
}
```

或设置环境变量：
```bash
DEBUG=mqtt-server node app.js
```

### 2. 查看详细日志

调试模式下会显示详细的连接和消息处理信息：
```
mqtt-server 客户端连接: { clientId: '...', username: '...', ... }
mqtt-server 收到发布消息: { topic: '...', payload: '...', qos: 0 }
mqtt-server 发送消息到 devices/p2p/...: {...}
```

### 3. 网络连通性测试

**测试WebSocket服务器：**
```bash
curl -I http://192.168.68.66:8000/xiaozhi/v1/
```

**测试MQTT端口：**
```bash
telnet localhost 1883
```

## 性能测试

### 并发连接测试

可以修改测试脚本创建多个并发连接：

```javascript
// 创建多个测试客户端
const clients = [];
for (let i = 0; i < 10; i++) {
    const client = new MQTTTestClient();
    clients.push(client);
    // 连接和测试...
}
```

### 消息吞吐量测试

发送大量消息测试转发性能：

```javascript
// 发送100条消息
for (let i = 0; i < 100; i++) {
    client.publish('test/topic', `测试消息 ${i}`);
}
```

## 故障排除清单

- [ ] MQTT网关服务是否运行 (`node app.js`)
- [ ] 端口1883是否被占用
- [ ] 配置文件格式是否正确
- [ ] WebSocket后端服务是否运行
- [ ] 网络连接是否正常
- [ ] MAC地址是否在配置的白名单中
- [ ] 客户端ID格式是否正确
- [ ] 防火墙是否阻止连接

## 总结

通过以上测试方法，你可以全面验证MQTT网关的转发功能是否配置成功。建议先运行快速测试，如果有问题再进行详细的手动测试和调试。