<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xiaozhi.modules.content.dao.ContentItemsDao">

    <resultMap id="contentItemsMap" type="xiaozhi.modules.content.entity.ContentItemsEntity">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="romanized" property="romanized"/>
        <result column="filename" property="filename"/>
        <result column="content_type" property="contentType"/>
        <result column="category" property="category"/>
        <result column="alternatives" property="alternatives"/>
        <result column="file_url" property="fileUrl"/>
        <result column="duration_seconds" property="durationSeconds"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="thumbnail_url" property="thumbnailUrl"/>
    </resultMap>

    <!-- Get paginated content items list with filters -->
    <select id="getContentItemsList" resultMap="contentItemsMap">
        SELECT *
        FROM content_items
        WHERE 1=1
        <if test="contentType != null and contentType != ''">
            AND content_type = #{contentType}
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="search != null and search != ''">
            AND (
                title LIKE CONCAT('%', #{search}, '%')
                OR romanized LIKE CONCAT('%', #{search}, '%')
                OR alternatives LIKE CONCAT('%', #{search}, '%')
            )
        </if>
        ORDER BY
        <if test="sortBy != null and sortBy != ''">
            ${sortBy}
            <if test="sortDirection != null and sortDirection != ''">
                ${sortDirection}
            </if>
        </if>
        <if test="sortBy == null or sortBy == ''">
            created_at DESC
        </if>
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Get total count for pagination -->
    <select id="getContentItemsCount" resultType="int">
        SELECT COUNT(*)
        FROM content_items
        WHERE 1=1
        <if test="contentType != null and contentType != ''">
            AND content_type = #{contentType}
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="search != null and search != ''">
            AND (
                title LIKE CONCAT('%', #{search}, '%')
                OR romanized LIKE CONCAT('%', #{search}, '%')
                OR alternatives LIKE CONCAT('%', #{search}, '%')
            )
        </if>
    </select>

    <!-- Get distinct categories by content type -->
    <select id="getCategoriesByType" resultType="String">
        SELECT DISTINCT category
        FROM content_items
        WHERE content_type = #{contentType}
        ORDER BY category ASC
    </select>

    <!-- Search content items by title or alternatives -->
    <select id="searchContentItems" resultMap="contentItemsMap">
        SELECT *
        FROM content_items
        WHERE 1=1
        <if test="contentType != null and contentType != ''">
            AND content_type = #{contentType}
        </if>
        AND (
            title LIKE CONCAT('%', #{query}, '%')
            OR romanized LIKE CONCAT('%', #{query}, '%')
            OR alternatives LIKE CONCAT('%', #{query}, '%')
        )
        ORDER BY
            CASE
                WHEN title LIKE CONCAT(#{query}, '%') THEN 1
                WHEN title LIKE CONCAT('%', #{query}, '%') THEN 2
                WHEN romanized LIKE CONCAT(#{query}, '%') THEN 3
                WHEN alternatives LIKE CONCAT('%', #{query}, '%') THEN 4
                ELSE 5
            END,
            title ASC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- Get search results count -->
    <select id="getSearchCount" resultType="int">
        SELECT COUNT(*)
        FROM content_items
        WHERE 1=1
        <if test="contentType != null and contentType != ''">
            AND content_type = #{contentType}
        </if>
        AND (
            title LIKE CONCAT('%', #{query}, '%')
            OR romanized LIKE CONCAT('%', #{query}, '%')
            OR alternatives LIKE CONCAT('%', #{query}, '%')
        )
    </select>

    <!-- Batch insert content items -->
    <insert id="batchInsert">
        INSERT INTO content_items (
            id, title, romanized, filename, content_type, category,
            alternatives, file_url, duration_seconds, created_at, updated_at, thumbnail_url
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.id}, #{item.title}, #{item.romanized}, #{item.filename},
                #{item.contentType}, #{item.category}, #{item.alternatives},
                #{item.fileUrl}, #{item.durationSeconds}, #{item.createdAt},
                #{item.updatedAt}, #{item.thumbnailUrl}
            )
        </foreach>
    </insert>

</mapper>
