<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xiaozhi.modules.content.dao.MusicPlaylistDao">

    <resultMap id="musicPlaylistMap" type="xiaozhi.modules.content.entity.MusicPlaylistEntity">
        <id column="id" property="id"/>
        <result column="device_id" property="deviceId"/>
        <result column="content_id" property="contentId"/>
        <result column="position" property="position"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- Get playlist for a specific device, ordered by position -->
    <select id="getPlaylistByDeviceId" resultMap="musicPlaylistMap">
        SELECT *
        FROM music_playlist
        WHERE device_id = #{deviceId}
        ORDER BY position ASC
    </select>

    <!-- Delete all playlist entries for a device -->
    <delete id="deleteByDeviceId">
        DELETE FROM music_playlist
        WHERE device_id = #{deviceId}
    </delete>

    <!-- Batch insert playlist entries -->
    <insert id="batchInsert">
        INSERT INTO music_playlist (device_id, content_id, position, created_at, updated_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.deviceId}, #{item.contentId}, #{item.position}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- Get max position for a device -->
    <select id="getMaxPosition" resultType="java.lang.Integer">
        SELECT MAX(position)
        FROM music_playlist
        WHERE device_id = #{deviceId}
    </select>

    <!-- Update position for a specific entry -->
    <update id="updatePosition">
        UPDATE music_playlist
        SET position = #{position}, updated_at = NOW()
        WHERE device_id = #{deviceId} AND content_id = #{contentId}
    </update>

    <!-- Delete a specific item from playlist -->
    <delete id="deleteByDeviceAndContent">
        DELETE FROM music_playlist
        WHERE device_id = #{deviceId} AND content_id = #{contentId}
    </delete>

    <!-- Shift positions down after deletion (to fill gaps) -->
    <update id="shiftPositionsDown">
        UPDATE music_playlist
        SET position = position - 1, updated_at = NOW()
        WHERE device_id = #{deviceId} AND position > #{startPosition}
    </update>

    <!-- Count playlist items for a device -->
    <select id="countByDeviceId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM music_playlist
        WHERE device_id = #{deviceId}
    </select>

</mapper>
